name: Smoke Tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Ballerina
      uses: ballerina-platform/setup-ballerina@v1
      with:
        version: 2201.12.8
    
    - name: Install h2load
      run: |
        # Install nghttp2-client which includes h2load
        sudo apt-get update -qq
        sudo apt-get install -y nghttp2-client
        h2load --version
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Cache Ballerina dependencies
      uses: actions/cache@v3
      with:
        path: ~/.ballerina
        key: ${{ runner.os }}-ballerina-${{ hashFiles('**/Ballerina.toml') }}
        restore-keys: ${{ runner.os }}-ballerina
    
    - name: Validate environment
      run: |
        chmod +x scripts/validate_setup.sh
        scripts/validate_setup.sh
    
    - name: Build projects
      run: |
        # Build Netty backend
        cd netty-backend
        mvn clean package -q
        cd ..
        
        # Build Ballerina project
        cd ballerina-passthrough
        bal build
        cd ..
        
        # Generate samples
        chmod +x scripts/generate_samples.sh
        scripts/generate_samples.sh
    
    - name: Run quick smoke test
      run: |
        chmod +x scripts/quick_test.sh
        
        # Run a very short test to validate everything works
        # Test h1c-h1c (simplest config) with small payload and few users
        timeout 300 scripts/quick_test.sh h1c-h1c 1KB 5 60 || {
          echo "Smoke test failed or timed out"
          
          # Show logs for debugging
          echo "=== Service Logs ==="
          cat quick_results/service.log || echo "No service log found"
          echo "=== Backend Logs ==="
          cat quick_results/netty_backend.log || echo "No backend log found"
          echo "=== Quick Test Logs ==="
          cat quick_results/quick_test.log || echo "No quick test log found"
          
          exit 1
        }
    
    - name: Verify results
      run: |
        # Check if results were generated
        if [ -f quick_results/quick_test_h1c-h1c_1KB_5users.csv ]; then
          echo "‚úÖ Test results generated successfully"
          samples=$(tail -n +2 quick_results/quick_test_h1c-h1c_1KB_5users.csv | wc -l)
          echo "üìä Total samples: $samples"
          
          if [ "$samples" -gt 0 ]; then
            # Calculate basic statistics from h2load CSV output
            avg_time=$(tail -n +2 quick_results/quick_test_h1c-h1c_1KB_5users.csv | awk -F',' '{sum+=$2} END {if(NR>0) printf "%.2f", sum/NR; else print "0"}')
            echo "‚úÖ Average response time: ${avg_time}ms"
          else
            echo "‚ùå No samples recorded"
            exit 1
          fi
        else
          echo "‚ùå No test results file found"
          exit 1
        fi
    
    - name: Upload smoke test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: |
          quick_results/
        retention-days: 7